# Configure the worker processes (1 is sufficient for this demo)
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include mime.types;

    # ----------------------------------------------------------------------
    # UPSTREAM CLUSTER (Load Balancing)
    # ----------------------------------------------------------------------
    # Defines the group of backend servers.
    # By default, Nginx uses the "Round Robin" algorithm to distribute traffic.
    # This means requests are sent to servers sequentially (1 -> 2 -> 3 -> 1...).
    upstream container_cluster {
        # These communicate with Docker containers mapped to the Minion's localhost.
        server 127.0.0.1:8081; # Maps to Container 1 (Blue)
        server 127.0.0.1:8082; # Maps to Container 2 (Pink)
        server 127.0.0.1:8083; # Maps to Container 3 (Yellow)
    }

    server {
        # Listen on Guest Port 80.
        # Traffic reaches here from the Host Machine's Port 8080 (via Vagrant forwarding).
        listen 80;
        server_name localhost;

        location / {
            # Forward incoming requests to the upstream cluster defined above
            proxy_pass http://container_cluster;

            # ------------------------------------------------------------------
            # PROXY HEADERS
            # ------------------------------------------------------------------
            # Pass original request information to the backend containers.
            # Without these, the backend would think all requests come from the proxy itself.
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            # ------------------------------------------------------------------
            # DISABLE CACHING (Demo Specific)
            # ------------------------------------------------------------------
            # We strictly disable caching to ensure the browser fetches a fresh
            # version of the page on every reload. This allows us to visualize
            # the Round-Robin color changing immediately.
            add_header Last-Modified $date_gmt;
            add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
            if_modified_since off;
            expires off;
            etag off;
        }
    }
}